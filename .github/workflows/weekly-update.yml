name: "Weekly Dependency Update"

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - uses: cachix/cachix-action@v14
        with:
          name: pepo
          signingKey: "${{ secrets.CACHIX_SIGNING_KEY }}"
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update Nix Flake Dependencies
        id: update_deps
        run: |
          echo "Updating flake inputs..."
          nix flake update --commit-lock-file

          # Check if there are changes
          if git diff --quiet HEAD~1 flake.lock; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Check Dev Shells Versions
        id: check_shells
        run: |
          echo "## Available Dev Shells" > dev_shells_info.txt
          nix flake show --json | jq -r '.devShells."x86_64-darwin" | keys[]' >> dev_shells_info.txt || true
          echo "" >> dev_shells_info.txt
          cat dev_shells_info.txt
          # Store for PR body
          echo "shells_info<<EOF" >> $GITHUB_OUTPUT
          cat dev_shells_info.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Prepare hostname for build
        run: |
          # GitHub runners use a local TLD which needs to be removed
          # Also x86_64-darwin instead of aarch64-darwin
          HOSTNAME=$(hostname | sed 's/.local//g')
          cat flake.nix | sed "s/buque/$HOSTNAME/g" | sed "s/aarch64-darwin/x86_64-darwin/g" > flake.nix.tmp
          mv flake.nix.tmp flake.nix
          echo "HOSTNAME=$HOSTNAME" >> $GITHUB_ENV

      - name: Test Nix Build
        run: |
          cachix use pepo
          nix build "./#darwinConfigurations.${{ env.HOSTNAME }}.system" --show-trace
        timeout-minutes: 120

      - name: Test Neovim Startup
        run: |
          # Build the config to get nvim in path
          export PATH="./result/sw/bin:$PATH"

          # Check if nvim is available
          if ! command -v nvim &> /dev/null; then
            echo "✗ Neovim not found in PATH"
            exit 1
          fi

          echo "Testing Neovim startup..."
          # Test nvim starts without errors using a timeout
          # Exit code 0 = success, 124 = timeout (which is ok for headless mode)
          timeout 10s nvim --headless +'checkhealth' +quitall > nvim_test.log 2>&1 || exit_code=$?

          # Try a simpler test if checkhealth fails
          if [ "${exit_code:-0}" -ne 0 ] && [ "${exit_code:-0}" -ne 124 ]; then
            echo "Trying simpler nvim test..."
            timeout 5s nvim --headless -c 'echo "test"' -c 'quitall' || exit_code=$?
          fi

          if [ "${exit_code:-0}" -eq 0 ] || [ "${exit_code:-0}" -eq 124 ]; then
            echo "✓ Neovim started successfully"
          else
            echo "✗ Neovim failed to start with exit code: $exit_code"
            cat nvim_test.log || true
            exit 1
          fi

      - name: Run Additional Tests
        run: |
          export PATH="./result/sw/bin:$PATH"

          echo "Testing git configuration..."
          git --version

          echo "Testing zsh configuration..."
          zsh --version

          echo "Testing basic utilities..."
          which fzf || echo "fzf not found but that's ok"
          which rg || echo "rg not found but that's ok"

      - name: Create Pull Request
        if: steps.update_deps.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: weekly dependency update"
          title: "chore: Weekly Nix dependency updates"
          body: |
            ## Weekly Dependency Update

            This PR was automatically generated by the weekly update workflow.

            ### Changes
            - Updated Nix flake dependencies via `nix flake update`
            - All tests passed:
              - ✅ Nix build successful
              - ✅ Neovim starts without errors
              - ✅ Basic utilities tested

            ### Dev Shells Information
            ${{ steps.check_shells.outputs.shells_info }}

            Please review the changes in `flake.lock` and merge if everything looks good.
          branch: automated/weekly-update
          delete-branch: true
          labels: |
            dependencies
            automated
