name: "system build"
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os:
          - macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - uses: cachix/cachix-action@v14
        with:
          name: pepo
          # If you chose signing key for write access
          signingKey: "${{ secrets.CACHIX_SIGNING_KEY }}"
          # If you chose API tokens for write access OR if you have a private cache
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Run Flake Checks for aarch64-darwin
        run: |
          # GitHub Actions now supports M1/M2 runners natively!
          # Build for aarch64 so binaries can be reused locally via Cachix
          nix flake check -v --show-trace --system aarch64-darwin
        timeout-minutes: 240

      - name: Build system configuration
        run: |
          # Build the buque configuration for aarch64-darwin
          # This will be cached to Cachix and reusable locally
          nix build "./#darwinConfigurations.buque.system" --verbose

          # Push all build outputs to Cachix
          nix path-info --all --json | jq -r 'keys[]' | cachix push pepo
          # error: Directory /run does not exist, aborting activation
          # Create a symlink to /var/run with:
          # $ printf 'run\tprivate/var/run\n' | sudo tee -a /etc/synthetic.conf
          # $ /System/Library/Filesystems/apfs.fs/Contents/Resources/apfs.util -B # For Catalina
          # $ /System/Library/Filesystems/apfs.fs/Contents/Resources/apfs.util -t # For Big Sur and later
          # The current contents of /etc/synthetic.conf is:
          #    nix
          # Error: Process completed with exit code 2.
          #
          # ./result/sw/bin/darwin-rebuild switch --flake "./#$(hostname | sed -E 's/\.local//g')"
